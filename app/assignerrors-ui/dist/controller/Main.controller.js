sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/BusyIndicator","sap/ui/model/json/JSONModel","sap/m/MessageBox"],(e,t,r,o)=>{"use strict";var s;return e.extend("ladera.fin.assignerrorsui.controller.Main",{onInit(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("RouteMain").attachPatternMatched(this.onRouteMatched,this)},onRouteMatched(e){this.getView().getModel("errorModel").setData([]);this.existingData=[];this.errorLogs=[];this.errorItem=this.getView().getModel("configModel").getData().ErrorLogItem;this.getView().setModel(this.errorLogs,"ErrorLogs");this.setDefaultData(e)},async setDefaultData(e){t.show();this.existingData=await this._getSavedErrors();var r=this.getView().getModel("errorModel");var o=[];if(this.existingData){for(let e=0;e<this.existingData.length;e++){const t=this.existingData[e];var s=this.getEmptyLine();s.errorCode=t.errorcode;s.description=t.description;s.departmentId=t.department;s.emailId=t.emailId;o.push(s)}r.setData(o)}this.setTableProperties();t.hide()},async _getSavedErrors(){const e=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);try{const r=await fetch(e+"/ErrorRecordSet",{method:"GET"});if(!r.ok){const e=await r.text();this.errorItem.errorCode=r.status;this.errorItem.message=e;this.errorItem.subtitle="Initial load";this.errorItem.activeTitle="Initial load";this.errorLogs.push(this.errorItem);this.viewLogs();t.hide()}else{const e=await r.json();return e.value}}catch(e){t.hide();o.error("Error while trying to fetch existing errors")}},viewLogs(){var e=this.getView().byId("re-fin-errorLog");e.setText(this.errorLogs.length);e.setVisible(true);var t=new sap.m.MessageItem({type:"Error",title:"{ErrorLogs>message}"});this.oMessagePopover=new sap.m.MessagePopover({items:{path:"ErrorLogs>/",template:t}});e.addDependent(this.oMessagePopover);e.firePress()},showErrorLogs(e){this.byId("re-fin-errorLog").addEventDelegate({onAfterRendering:function(){s.openBy(this.byId("re-fin-errorLog"))}},this);this.oMessagePopover.toggle(e.getSource())},onEdit(e){var t=e.getSource().getParent().getBindingContext("errorModel").sPath.split("/")[1];this.enableEdit(t)},enableEdit(e){const t=this.getView().byId("re-fin-errorTable");const r=t.getItems()[e].getAggregation("cells");for(let e=0;e<r.length-2;e++){const t=r[e];t.setEditable(true)}},async onDelete(e){var t=e.getSource().getParent().getBindingContext("errorModel").sPath.split("/")[1];const r=e.getSource().getModel("errorModel").getData()[t];const s=this.existingData.some(e=>e.errorcode===r.errorCode);if(s){var i=this;o.confirm("Are you sure? This entry will be permanently deleted from the database.",{actions:["Yes",o.Action.CLOSE],emphasizedAction:"CLOSE",onClose:function(t){if(t==="Yes"){i.removeEntry(r,e)}}})}else{e.getSource().getModel("errorModel").getData().splice(t,1);e.getSource().getModel("errorModel").refresh()}this.setTableProperties()},async removeEntry(e,t){const r=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);const s=this.existingData.find(t=>t.errorcode===e.errorCode);if(s.ID){$.ajax(r+"/ErrorRecordSet"+`('${s.ID}')`,{type:"DELETE",success:function(e){o.success("Error Code: "+s.errorcode+" has been deleted");const r=t.getSource().getParent().getBindingContext("errorModel").sPath.split("/")[1];t.getSource().getModel("errorModel").getData().splice(r,1);t.getSource().getModel("errorModel").refresh()},error:function(e){o.error(JSON.parse(e.responseText).error.message)}})}},async onSave(e){t.show();var r=[];var s=this.getView().getModel("errorModel").getData();var i={};for(let e=0;e<s.length;e++){var a=s[e];var n=this.existingData.some(e=>e.errorcode===a.errorCode);if(!n){o}else{i={errorcode:a.errorCode,description:a.description,department:a.departmentId,emailId:a.emailId};r.push(this.getSavePromise(i))}}var g=[];if(r){await Promise.all(r).then(function(r,s){g.push(r);this.setDefaultData(e);t.hide();o.success("Data saved successfully")}).catch(function(e){t.hide();var r=JSON.parse(e.responseText).error;o.error(r)})}},getSavePromise(e){const t=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);return new Promise(function(r,o){$.ajax(t+"/ErrorRecordSet",{type:"POST",contentType:"application/json",data:JSON.stringify(e),success:function(e){r(e)},error:function(e){o(e)}})})},onAddItem(e){var t=this.getView().getModel("errorModel");var r=t.getData();var o=this.getEmptyLine();r.unshift(o);t.setData(r);t.refresh();this.setTableProperties()},setTableProperties(){var e=this.getView().byId("re-fin-errorTable");var t=e.getItems();for(let e=0;e<t.length;e++){const o=t[e];var r=o.getCells()[0].getProperty("value");if(this.existingData.some(e=>e.errorcode===r)){o.setHighlight("Success");o.setHighlightText("Pending to save")}else{o.setHighlight("Warning");o.setHighlightText("Saved")}}},getEmptyLine(){return{errorCode:"",description:"",departmentId:"",emailId:""}}})});
//# sourceMappingURL=Main.controller.js.map