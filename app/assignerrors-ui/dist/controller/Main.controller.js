sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/BusyIndicator","sap/m/MessageBox"],(e,t,r)=>{"use strict";return e.extend("ladera.fin.assignerrorsui.controller.Main",{onInit(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("RouteMain").attachPatternMatched(this.onRouteMatched,this)},onRouteMatched(e){this.getView().getModel("errorModel").setData([]);this.existingData=[];this.setDefaultData(e)},async setDefaultData(e){t.show();this.existingData=await this._getSavedErrors();var r=this.getView().getModel("errorModel");var a=[];if(this.existingData){for(let e=0;e<this.existingData.length;e++){const t=this.existingData[e];var o=this.getEmptyLine();o.errorCode=t.errorcode;o.description=t.description;o.departmentId=t.department;o.emailId=t.emailId;a.push(o)}r.setData(a)}t.hide()},async _getSavedErrors(){const e=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);try{const a=await fetch(e+"/ErrorRecordSet",{method:"GET"});if(!a.ok){const e=await a.text();t.hide();r.error(e)}else{const e=await a.json();return e.value}}catch(e){t.hide();r.error("Error while trying to fetch existing errors")}},onEdit(e){var t=e.getSource().getParent().getBindingContext("errorModel").sPath.split("/")[1];this.enableEdit(t)},enableEdit(e){const t=this.getView().byId("re-fin-errorTable");const r=t.getItems()[e].getAggregation("cells");for(let e=0;e<r.length-2;e++){const t=r[e];t.setEditable(true)}},async onDelete(e){var t=false;var a=e.getSource().getParent().getBindingContext("errorModel").sPath.split("/")[1];const o=e.getSource().getModel("errorModel").getData()[a];const i=this.existingData.some(e=>e.errorcode===o);if(i){r.confirm("Are you sure? This entry will be permanently deleted from the database.",{actions:["Yes",r.Action.CLOSE],emphasizedAction:"CLOSE",onClose:function(e){t=true}});if(t){await this.removeEntry(o)}}else{e.getSource().getModel("errorModel").getData().splice(a,1);e.getSource().getModel("errorModel").refresh()}},async removeEntry(e){const t=this.existingData.find(t=>t.errorcode===e)},async onSave(e){t.show();var a=[];var o=this.getView().getModel("errorModel").getData();var i={};for(let e=0;e<o.length;e++){var s=o[e];var n=this.existingData.some(e=>e.errorcode===s.errorCode);if(!n){i={errorcode:s.errorCode,description:s.description,department:s.departmentId,emailId:s.emailId};a.push(this.getSavePromise(i))}}var d=[];if(a){await Promise.all(a).then(function(e,t){d.push(e)}).catch(function(e){t.hide();r.error(JSON.parse(e.responseText).error.message)});await this.setDefaultData(e);t.hide();r.success("Data saved successfully")}},getSavePromise(e){const t=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);return new Promise(function(r,a){$.ajax(t+"/ErrorRecordSet",{type:"POST",contentType:"application/json",data:JSON.stringify(e),success:function(e){r(e)},error:function(e){a(e)}})})},onAddItem(e){var t=this.getView().getModel("errorModel");var r=t.getData();var a=this.getEmptyLine();r.unshift(a);t.setData(r);t.refresh()},setTableProperties(){var e=this.getView().byId("re-fin-errorTable");var t=e.getItems();for(let e=0;e<t.length;e++){var r=t[e];var a=r.getAggregation("cells");var o=a[0].getValue();for(let e=0;e<a.length-2;e++){if(this.existingData.some(e=>e.errorcode===o)){a[e].setEditable(false)}else{a[e].setEditable(true)}}}},getEmptyLine(){return{errorCode:"",description:"",departmentId:"",emailId:""}}})});
//# sourceMappingURL=Main.controller.js.map