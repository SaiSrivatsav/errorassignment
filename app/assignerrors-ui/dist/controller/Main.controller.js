sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/BusyIndicator","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/m/MessagePopover","sap/ui/dom/isBehindOtherElement","sap/ui/core/Element"],(e,t,r,s,o,i,a,n,g)=>{"use strict";var d;return e.extend("ladera.fin.assignerrorsui.controller.Main",{onInit(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("RouteMain").attachPatternMatched(this.onRouteMatched,this)},onRouteMatched(e){this.getView().getModel("errorModel").setData([]);this.existingData=[];this._MessageManager=o;this._MessageManager.removeAllMessages();this._MessageManager.registerObject(this.getView().byId("re-fin-errorTable"),true);this.getView().setModel(this._MessageManager.getMessageModel(),"message");this.errorLogs=[];this.errorItem=this.getView().getModel("configModel").getData().ErrorLogItem;var t=new r;this.getView().setModel(t,"ErrorLogs");this.setDefaultData(e)},createErrorPopover(){var e=this;this.oMessagePopover=new a({activeTitlePress:function(t){var r=t.getParameter("item"),s=e.getView().byId("re-fin-dynPage"),o=r.getBindingContext("message").getObject(),i=g.registry.get(o.getControlId());if(i){s.scrollToElement(i.getDomRef(),200,[0,-100]);setTimeout(function(){var e=n(i.getDomRef());if(e){this.close()}if(i.isFocusable()){i.focus()}}.bind(this),300)}},items:{path:"ErrorLogs>/",template:new MessageItem({title:"{ErrorLogs>message}",subtitle:"{ErrorLogs>additionalText}",groupName:{parts:[{path:"message>controlIds"}],formatter:this.getGroupName},activeTitle:{parts:[{path:"message>controlIds"}],formatter:this.isPositionable},type:"{message>type}",description:"{message>message}"})},groupItems:true});this.getView().byId("messagePopoverBtn").addDependent(this.oMessagePopover)},getGroupName(e){var t=g.registry.get(e);return"Error code"},isPositionable(e){return e?true:true},async setDefaultData(e){t.show();this.existingData=await this._getSavedErrors();var r=this.getView().getModel("errorModel");var s=[];if(this.existingData){for(let e=0;e<this.existingData.length;e++){const t=this.existingData[e];var o=this.getEmptyLine();o.errorCode=t.errorcode;o.description=t.description;o.departmentId=t.department;o.emailId=t.emailId;o.saved=true;s.push(o)}r.setData(s)}this.setTableProperties();t.hide()},async _getSavedErrors(){const e=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);try{const r=await fetch(e+"/ErrorRecordSet",{method:"GET"});if(!r.ok){const e=await r.text();let s={errorCode:r.status,message:e,subtitle:"Initial load",target:"",title:"Initial load",activeTitle:"Initial fetch",groupName:r.status};this.errorLogs.push(s);this.getView().getModel("ErrorLogs").setData(this.errorLogs);this.viewLogs();t.hide()}else{const e=await r.json();return e.value}}catch(e){t.hide();s.error("Error while trying to fetch existing errors")}},viewLogs(){var e=this.getView().byId("re-fin-errorLog");e.setText(this.errorLogs.length);e.setVisible(true);var t=new sap.m.MessageItem({type:"Error",title:"{ErrorLogs>message}"});this.oMessagePopover=new sap.m.MessagePopover({items:{path:"ErrorLogs>/",template:t},groupItems:true});e.addDependent(this.oMessagePopover);e.firePress()},showErrorLogs(e){this.byId("re-fin-errorLog").addEventDelegate({onAfterRendering:function(){this.oMessagePopover.openBy(this.byId("re-fin-errorLog"))}},this);this.oMessagePopover.toggle(e.getSource())},onEdit(e){var t=e.getSource().getParent().getBindingContext("errorModel").sPath.split("/")[1];this.enableEdit(t)},enableEdit(e){const t=this.getView().byId("re-fin-errorTable");const r=t.getItems()[e].getAggregation("cells");for(let e=0;e<r.length-2;e++){const t=r[e];t.setEditable(true)}},async onDelete(e){var t=e.getSource().getParent().getBindingContext("errorModel").sPath.split("/")[1];const r=e.getSource().getModel("errorModel").getData()[t];const o=this.existingData.some(e=>e.errorcode===r.errorCode);if(o&&r.saved){var i=this;s.confirm("Are you sure? This entry will be permanently deleted from the database.",{actions:["Yes",s.Action.CLOSE],emphasizedAction:"CLOSE",onClose:async function(s){if(s==="Yes"){const s=await i.removeEntry(r,e);if(s){e.getSource().getModel("errorModel").getData().splice(t,1);e.getSource().getModel("errorModel").refresh()}}}})}else{e.getSource().getModel("errorModel").getData().splice(t,1);e.getSource().getModel("errorModel").refresh()}this.setTableProperties()},async removeEntry(e,t){const r=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);const o=this.existingData.find(t=>t.errorcode===e.errorCode);if(o.ID){$.ajax(r+"/ErrorRecordSet"+`('${o.ID}')`,{type:"DELETE",success:function(e){s.success("Error Code: "+o.errorcode+" has been deleted");const r=t.getSource().getParent().getBindingContext("errorModel").sPath.split("/")[1];t.getSource().getModel("errorModel").getData().splice(r,1);t.getSource().getModel("errorModel").refresh();return true},error:function(e){s.error(JSON.parse(e.responseText).error.message);return false}})}},async onSave(e){t.show();var r=[];var o=[];var i=true;var a=this.getView().getModel("errorModel").getData();var n={};var g={};var d=this.getMandatoryCheck();if(d){for(let e=0;e<a.length;e++){var l=a[e];if(!l.saved){var c=this.existingData.some(e=>e.errorcode===l.errorCode);if(c){s.error(`Error code ${l.errorCode}  already exists.`);i=false;t.hide();break}else{n={errorcode:l.errorCode,description:l.description,department:l.departmentId,emailId:l.emailId};r.push(this.getSavePromise(n))}}else{g={errorcode:l.errorCode,description:l.description,department:l.departmentId,emailId:l.emailId};const e=this.existingData.find(e=>e.errorcode===l.errorCode).ID;r.push(this.getUpdatePromise(g,e))}}var h=[];var p=this;if(r.length>0&&i){await Promise.all(r).then(function(r,o){h.push(r);p.setDefaultData(e);t.hide();s.success("Data saved and updated successfully")}).catch(function(e){t.hide();var r=JSON.parse(e.responseText).error;s.error(r)})}else{t.hide()}}else{t.hide()}},getMandatoryCheck(){var e=0;const t=this.getView().getModel("errorModel").getData();var r=this.getView().byId("re-fin-errorTable");var s=r.getItems();for(let t=0;t<s.length;t++){const r=s[t];for(let t=0;t<r.getCells().length-1;t++){var o=r.getCells()[t];if(o.getValue()===""){o.setValueState("Error");o.setValueStateText("Value is required");e++}else{o.setValueState("None");o.setValueStateText("")}}}if(e>0){return false}else{return true}},getSavePromise(e){const t=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);return new Promise(function(r,s){$.ajax(t+"/ErrorRecordSet",{type:"POST",contentType:"application/json",data:JSON.stringify(e),success:function(e){r(e)},error:function(e){s(e)}})})},getUpdatePromise(e,t){const r=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);return new Promise(function(s,o){$.ajax(r+"/ErrorRecordSet/"+t,{type:"PUT",contentType:"application/json",data:JSON.stringify(e),success:function(e){s(e)},error:function(e){o(e)}})})},onAddItem(e){var t=this.getView().getModel("errorModel");var r=t.getData();var s=this.getEmptyLine();r.unshift(s);t.setData(r);t.refresh();this.setTableProperties()},setTableProperties(){const e=this.getView().getModel("errorModel").getData();const t=this.existingData.length;this.getView().byId("re-fin-tabTitle").setText(`Errors Assigned (${t})`);var r=this.getView().byId("re-fin-errorTable");var s=r.getItems();for(let t=0;t<s.length;t++){const r=s[t];var o=r.getCells()[0].getProperty("value");if(this.existingData.some(e=>e.errorcode===o)&&e[t].saved){r.setHighlight("Success");r.setHighlightText("Pending to save")}else{r.setHighlight("Warning");r.setHighlightText("Saved")}}},getEmptyLine(){return{errorCode:"",description:"",departmentId:"",emailId:"",saved:false}}})});
//# sourceMappingURL=Main.controller.js.map